sequenceDiagram
    actor User
    participant Client
    participant Router
    participant Manager as Manager Agent
    participant Tool as Tool Agent
    participant Redis as Chat History
    participant LLM as Gemini 2.5 Pro
    participant MCP as OXII MCP Server

    Note over User,MCP: Case 2: Device Control (Incomplete) - Phase 1 Only<br/>Total: ~16s (04:39:10 â†’ 04:39:26) - Log truncated

    %% Request Phase
    User->>Client: "Turn On Light 1 in the bed room"
    Client->>Router: POST /ai/chat/text
    activate Router

    %% Manager Processing
    Router->>Manager: {input, token, sessionId}
    activate Manager
    Note over Manager: 04:39:10.000<br/>âš¡ Init: instant

    rect rgb(200, 220, 240)
        Note over Manager,LLM: ğŸ” ANALYZE_QUERY
        Manager->>Redis: Load context
        activate Redis
        Redis-->>Manager: 5 previous messages
        deactivate Redis

        Manager->>LLM: Analyze with context
        activate LLM
        Note over LLM: 04:39:10.000 â†’ 04:39:20.000<br/>â±ï¸ ~10s
        LLM-->>Manager: agent_type: tool<br/>confidence: 1.00
        deactivate LLM
        Note over Manager: 04:39:20.000<br/>ğŸ¯ Route to Tool Agent
    end

    rect rgb(220, 240, 200)
        Note over Manager,MCP: ğŸš€ DELEGATE to Tool Agent
        Manager->>Tool: Initialize ToolAgent<br/>{input, token}
        activate Tool
        
        Tool->>MCP: Connect SSE<br/>session: aae96377...
        activate MCP
        MCP-->>Tool: Load 13 tools
        deactivate MCP
        Note over Tool: 04:39:20.000<br/>âš¡ Init: instant
    end

    rect rgb(240, 220, 240)
        Note over Tool,MCP: ğŸ§  ITERATION 0: Reasoning
        Tool->>LLM: reason_and_plan()<br/>TOOL_PROMPT + 13 tools
        activate LLM
        Note over LLM: 04:39:20.000 â†’ 04:39:26.000<br/>â±ï¸ ~6s
        LLM-->>Tool: tool_calls: [get_device_list]
        deactivate LLM
        Note over Tool: Plan: Get devices first
    end

    rect rgb(220, 240, 220)
        Note over Tool,MCP: âš™ï¸ EXECUTION: get_device_list
        Tool->>MCP: Fresh client<br/>session: e19a5aca...
        activate MCP
        MCP-->>Tool: Device list with rooms
        deactivate MCP
        Note over Tool: 04:39:26.000<br/>Results stored in state
    end

    Note over User,MCP: âš ï¸ LOG TRUNCATED - Phase 1 complete<br/>Expected: Iteration 1 â†’ switch_on_off_v2 â†’ Iteration 2 finalize<br/>Estimated total time: ~30s (similar to Case 3)

    Tool->>Tool: [Missing logs]<br/>Iteration 1-2 expected
    
    Tool-->>Manager: [Expected] {output, success: true}
    deactivate Tool

    Manager->>Redis: [Expected] Save conversation
    Manager-->>Router: [Expected] Success
    deactivate Manager
    Router-->>Client: [Expected] HTTP 200
    deactivate Router
    Client-->>User: [Expected] Device controlled

    %% Timing Breakdown
    Note over User,MCP: â±ï¸ Visible Timing (Phase 1 only):<br/>â€¢ Manager Analysis (LLM): ~10s<br/>â€¢ Tool Init (MCP): instant<br/>â€¢ Iteration 0 (Reasoning): ~6s<br/>â€¢ get_device_list execution: instant<br/>â€¢ Visible total: ~16s<br/><br/>âš ï¸ Missing: Iteration 1-2 (control + finalize)<br/>ğŸ“Š Expected full total: ~30s<br/>ğŸ”´ Bottleneck: LLM reasoning<br/>ğŸ’¡ Architecture: Managerâ†’Toolâ†’LangGraph
