sequenceDiagram
    actor User
    participant Client
    participant Router
    participant Manager as Manager Agent
    participant Tool as Tool Agent
    participant Redis as Chat History
    participant LLM as Gemini 2.5 Pro
    participant MCP as OXII MCP Server

    Note over User,MCP: Case 3: Turn On Device - Manager â†’ Tool Agent Flow<br/>Total: 29.91s (04:41:33 â†’ 04:42:03)

    %% Request Phase
    User->>Client: "Turn On Light 1 in the bed room"
    Client->>Router: POST /ai/chat/text
    activate Router

    %% Manager Processing
    Router->>Manager: {input, token, sessionId}
    activate Manager
    Note over Manager: 04:41:33.703<br/>âš¡ Init: 0.006s

    rect rgb(200, 220, 240)
        Note over Manager,LLM: ğŸ” ANALYZE_QUERY
        Manager->>Redis: Load context
        activate Redis
        Redis-->>Manager: 5 previous messages
        deactivate Redis

        Manager->>LLM: Analyze with context
        activate LLM
        Note over LLM: 04:41:33.706 â†’ 04:41:42.204<br/>â±ï¸ 8.498s
        LLM-->>Manager: agent_type: tool<br/>confidence: 1.00
        deactivate LLM
        Note over Manager: 04:41:42.204<br/>ğŸ¯ Route to Tool Agent
    end

    rect rgb(220, 240, 200)
        Note over Manager,MCP: ğŸš€ DELEGATE to Tool Agent
        Manager->>Tool: Initialize ToolAgent<br/>{input, token}
        activate Tool
        
        Tool->>MCP: Connect SSE<br/>session: 2206e1bb...
        activate MCP
        MCP-->>Tool: Load 13 tools
        deactivate MCP
        Note over Tool: 04:41:43.293<br/>âš¡ Init: 1.088s
    end

    rect rgb(240, 220, 240)
        Note over Tool,MCP: ğŸ§  ITERATION 0: Reasoning
        Tool->>LLM: reason_and_plan()<br/>TOOL_PROMPT + 13 tools
        activate LLM
        Note over LLM: 04:41:43.297 â†’ 04:41:49.578<br/>â±ï¸ 6.281s
        LLM-->>Tool: tool_calls: [get_device_list]
        deactivate LLM
        Note over Tool: Plan: Get devices first
    end

    rect rgb(220, 240, 220)
        Note over Tool,MCP: âš™ï¸ EXECUTION: get_device_list
        Tool->>MCP: Fresh client<br/>session: (implicitly executed)
        activate MCP
        MCP-->>Tool: Device list with rooms
        deactivate MCP
        Note over Tool: Results stored in state
    end

    rect rgb(240, 220, 240)
        Note over Tool,MCP: ğŸ§  ITERATION 1: Reasoning
        Tool->>LLM: reason_and_plan()<br/>+ device list results
        activate LLM
        Note over LLM: 04:41:50.265 â†’ 04:41:58.043<br/>â±ï¸ 7.778s
        LLM-->>Tool: tool_calls: [switch_on_off_v2]<br/>buttonId: 1662, data: 1.0
        deactivate LLM
        Note over Tool: Plan control execution
    end

    rect rgb(220, 240, 220)
        Note over Tool,MCP: âš¡ EXECUTION: switch_on_off_v2
        Tool->>MCP: Fresh client<br/>session: 3270ee0d...
        activate MCP
        Note over MCP: 04:41:58.589 â†’ 04:42:00.936<br/>â±ï¸ 2.347s
        MCP-->>Tool: âœ… "ÄÃ¨n 1 Ä‘Ã£ báº­t thÃ nh cÃ´ng"
        deactivate MCP
        Note over Tool: 04:42:00.936<br/>Cleanup MCP client
    end

    rect rgb(240, 220, 240)
        Note over Tool,LLM: ğŸ§  ITERATION 2: Finalize
        Tool->>LLM: reason_and_plan()<br/>+ execution results
        activate LLM
        Note over LLM: 04:42:00.940 â†’ 04:42:03.604<br/>â±ï¸ 2.664s
        LLM-->>Tool: output: "Command sent successfully"<br/>NO tool_calls (done)
        deactivate LLM
        Note over Tool: 04:42:03.607<br/>âœ¨ FINAL OUTPUT ready
    end

    Tool-->>Manager: {output, success: true}
    deactivate Tool

    rect rgb(240, 220, 200)
        Note over Manager: ğŸ“ FINALIZE
        Manager->>Manager: format_tool_response()
        Note over Manager: 04:42:03.608
    end

    Manager->>Redis: Save conversation
    activate Redis
    Redis-->>Manager: âœ… Saved
    deactivate Redis

    Manager-->>Router: Success (29.91s)
    deactivate Manager
    Router-->>Client: HTTP 200
    deactivate Router
    Client-->>User: "ÄÃ¨n 1 Ä‘Ã£ báº­t"

    %% Timing Breakdown
    Note over User,MCP: â±ï¸ Timing Breakdown:<br/>â€¢ Manager Analysis (LLM): 8.498s<br/>â€¢ Tool Init (MCP): 1.088s<br/>â€¢ Iteration 0 (Reasoning): 6.281s<br/>â€¢ Iteration 1 (Reasoning): 7.778s<br/>â€¢ Execution (MCP switch): 2.347s<br/>â€¢ Iteration 2 (Finalize): 2.664s<br/>â€¢ Save + finalize: 0.254s<br/>â€¢ Total: 29.91s<br/><br/>ğŸ”´ Bottleneck: LLM reasoning (16.723s total)<br/>ğŸ’¡ Architecture: Managerâ†’Toolâ†’LangGraph (3 iterations)
