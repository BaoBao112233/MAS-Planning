sequenceDiagram
    actor User
    participant Client
    participant Router
    participant Manager as Manager Agent
    participant Plan as Plan Agent
    participant Redis
    participant LLM as Gemini 2.5 Pro
    participant MCP as OXII MCP Server
    participant Tool as Tool Agent

    Note over User,Tool: Case 5: Plan Creation + Execution (2 Phases)<br/>Phase 1: 45.39s | Phase 2: 59.66s | Total: 105.05s

    %% === PHASE 1: PLAN CREATION (Request 1) ===
    rect rgb(200, 200, 250)
        Note over User,Tool: ğŸ“‹ PHASE 1: PLAN CREATION (45.39s)
        
        User->>Client: "Have 1 person in Bed room.<br/>Temperature: 20C. Create Plan."
        Client->>Router: POST /ai/chat/text
        activate Router
        
        Router->>Manager: {input, token}
        activate Manager
        Note over Manager: 04:44:06.247<br/>Init: 0.007s
        
        Manager->>Redis: Load context
        Redis-->>Manager: 6 messages
        
        Manager->>LLM: Analyze query
        activate LLM
        Note over LLM: 6.157s
        LLM-->>Manager: agent_type: plan<br/>confidence: 1.00
        deactivate LLM
        
        Manager->>Plan: Initialize PlanAgent
        activate Plan
        Note over Plan: 04:44:13.951<br/>Init + MCP: 1.537s
        
        rect rgb(220, 240, 220)
            Note over Plan,MCP: STEP 1: Analyze User Input
            Plan->>LLM: ANALYZE_INPUT_PROMPT
            activate LLM
            Note over LLM: 04:44:13.952 â†’ 04:44:28.290<br/>â±ï¸ 14.338s
            LLM-->>Plan: Primary Intent: Create plan<br/>Requirements: 20Â°C, 1 person
            deactivate LLM
        end
        
        rect rgb(220, 240, 220)
            Note over Plan,MCP: STEP 2: Get Device List
            Plan->>MCP: get_device_list (fresh client)
            activate MCP
            Note over MCP: 04:44:28.291 â†’ 04:44:29.024<br/>â±ï¸ 0.733s
            MCP-->>Plan: 13,757 chars<br/>6 rooms with devices
            deactivate MCP
        end
        
        rect rgb(220, 240, 220)
            Note over Plan,LLM: STEP 3: Create 3 Plans
            Plan->>LLM: CREATE_PLANS_PROMPT<br/>+ device context
            activate LLM
            Note over LLM: 04:44:29.024 â†’ 04:44:51.630<br/>â±ï¸ 22.606s
            LLM-->>Plan: Security Plan (3 tasks)<br/>Convenience Plan (3 tasks)<br/>Energy Plan (3 tasks)
            deactivate LLM
        end
        
        Plan-->>Manager: plan_options + output<br/>"waiting_for_selection"
        deactivate Plan
        
        Manager->>Redis: Save conversation
        Manager-->>Router: Plan options<br/>(45.39s)
        deactivate Manager
        Router-->>Client: 3 plan options
        deactivate Router
        Client-->>User: Display 3 plans
    end

    %% === PHASE 2: PLAN EXECUTION (Request 2) ===
    rect rgb(250, 220, 200)
        Note over User,Tool: ğŸš€ PHASE 2: PLAN EXECUTION (59.66s)
        
        User->>Client: "Plan 1"
        Client->>Router: POST /ai/chat/text
        activate Router
        
        Router->>Manager: {input: "Plan 1", token}<br/>+ cached plan_options
        activate Manager
        Note over Manager: 04:45:10.151<br/>Load cached plans
        
        Manager->>LLM: Analyze "Plan 1"
        activate LLM
        Note over LLM: 5.642s
        LLM-->>Manager: agent_type: plan<br/>selection detected
        deactivate LLM
        
        Manager->>Plan: Initialize + selected_plan_id=1
        activate Plan
        Note over Plan: 04:45:17.280<br/>âœ… Security Priority Plan selected
        
        rect rgb(240, 230, 220)
            Note over Plan,Tool: ğŸ“Œ TASK 1: Turn off ÄÃ¨n tráº§n (20.18s)
            Note over Plan: 04:45:18.122 - Init Tool Agent
            
            Plan->>Tool: Task 1/3<br/>"Turn off ÄÃ¨n tráº§n in Bed room"
            activate Tool
            Note over Tool: 04:45:18.625 - Loaded 13 tools
            
            Plan->>MCP: Update task status â†’ RUNNING
            
            Tool->>LLM: ğŸ§  Iteration 0 Reasoning
            activate LLM
            Note over LLM: 04:45:18.928 â†’ 04:45:26.342<br/>â±ï¸ 7.414s
            LLM-->>Tool: Plan: get_device_list
            deactivate LLM
            
            Tool->>MCP: get_device_list (session: 28679df6...)
            activate MCP
            Note over MCP: 04:45:26.889 â†’ 04:45:27.071<br/>â±ï¸ 0.182s
            MCP-->>Tool: Device list with buttonId 1927
            deactivate MCP
            
            Tool->>LLM: ğŸ§  Iteration 1 Reasoning
            activate LLM
            Note over LLM: 04:45:27.077 â†’ 04:45:33.243<br/>â±ï¸ 6.166s
            LLM-->>Tool: Execute: switch_on_off_v2<br/>buttonId=1927, data=0.0
            deactivate LLM
            
            Tool->>MCP: switch_on_off_controls_v2<br/>(session: 055dcf34...)
            activate MCP
            Note over MCP: 04:45:33.818 â†’ 04:45:34.123<br/>â±ï¸ 0.305s
            MCP-->>Tool: âœ… "ÄÃ¨n tráº§n Ä‘Ã£ Ä‘Æ°á»£c táº¯t"
            deactivate MCP
            
            Tool->>LLM: ğŸ§  Iteration 2 Finalize
            activate LLM
            Note over LLM: 04:45:34.128 â†’ 04:45:39.294<br/>â±ï¸ 5.166s
            LLM-->>Tool: âœ… Final output
            deactivate LLM
            
            Tool-->>Plan: âœ… Task 1 completed (20.18s)
            deactivate Tool
            
            Plan->>MCP: Update task â†’ DONE
            Note over Plan: 04:45:39.294
        end
        
        rect rgb(240, 230, 220)
            Note over Plan,Tool: ğŸ“Œ TASK 2: Turn off ÄÃ¨n Ä‘á»c sÃ¡ch (17.61s)
            Note over Plan: 04:45:39.295 - Init Tool Agent
            
            Plan->>Tool: Task 2/3<br/>"Turn off ÄÃ¨n Ä‘á»c sÃ¡ch in Bed room"
            activate Tool
            
            Plan->>MCP: Update task status â†’ RUNNING
            
            Tool->>LLM: ğŸ§  Iteration 0 Reasoning
            activate LLM
            Note over LLM: 04:45:39.560 â†’ 04:45:47.663<br/>â±ï¸ 8.103s
            LLM-->>Tool: Plan: get_device_list
            deactivate LLM
            
            Tool->>MCP: get_device_list (session: 995fc20b...)
            activate MCP
            Note over MCP: 04:45:48.731 â†’ 04:45:48.920<br/>â±ï¸ 0.189s (from logs)
            MCP-->>Tool: Device list with buttonId 1929
            deactivate MCP
            
            Tool->>LLM: ğŸ§  Iteration 1 Reasoning
            activate LLM
            Note over LLM: 04:45:48.930 â†’ 04:45:52.762<br/>â±ï¸ 3.832s
            LLM-->>Tool: Execute: switch_on_off_v2<br/>buttonId=1929, data=0.0
            deactivate LLM
            
            Tool->>MCP: switch_on_off_controls_v2
            activate MCP
            Note over MCP: Network call (~4s estimated)
            MCP-->>Tool: âœ… "ÄÃ¨n Ä‘á»c sÃ¡ch Ä‘Ã£ Ä‘Æ°á»£c táº¯t"
            deactivate MCP
            
            Tool->>LLM: ğŸ§  Iteration 2 Finalize
            activate LLM
            Note over LLM: (~1.5s estimated)
            LLM-->>Tool: âœ… Final output
            deactivate LLM
            
            Tool-->>Plan: âœ… Task 2 completed (17.61s)
            deactivate Tool
            
            Plan->>MCP: Update task â†’ DONE
            Note over Plan: 04:45:56.907
        end
        
        rect rgb(240, 230, 220)
            Note over Plan,Tool: ğŸ“Œ TASK 3: Turn on ÄÃ¨n ngá»§ (13.45s)
            Note over Plan: 04:45:56.909 - Init Tool Agent
            
            Plan->>Tool: Task 3/3<br/>"Turn on ÄÃ¨n ngá»§ to simulate presence"
            activate Tool
            
            Plan->>MCP: Update task status â†’ RUNNING
            
            Tool->>LLM: ğŸ§  Iteration 0 Reasoning
            activate LLM
            Note over LLM: (~4.3s estimated)
            LLM-->>Tool: Plan: get_device_list
            deactivate LLM
            
            Tool->>MCP: get_device_list
            activate MCP
            Note over MCP: 04:46:01.508 â†’ 04:46:02.241<br/>â±ï¸ 0.733s
            MCP-->>Tool: Device list with buttonId 1926
            deactivate MCP
            
            Tool->>LLM: ğŸ§  Iteration 1 Reasoning
            activate LLM
            Note over LLM: 04:46:02.247 â†’ 04:46:06.072<br/>â±ï¸ 3.825s
            LLM-->>Tool: Execute: switch_on_off_v2<br/>buttonId=1926, data=1.0 (ON)
            deactivate LLM
            
            Tool->>MCP: switch_on_off_controls_v2<br/>(session: f4ab1541...)
            activate MCP
            Note over MCP: 04:46:06.658 â†’ 04:46:08.016<br/>â±ï¸ 1.358s
            MCP-->>Tool: âœ… "ÄÃ¨n ngá»§ Ä‘Ã£ Ä‘Æ°á»£c báº­t"
            deactivate MCP
            
            Tool->>LLM: ğŸ§  Iteration 2 Finalize
            activate LLM
            Note over LLM: 04:46:08.021 â†’ 04:46:09.245<br/>â±ï¸ 1.224s
            LLM-->>Tool: âœ… Final output
            deactivate LLM
            
            Tool-->>Plan: âœ… Task 3 completed (13.45s)
            deactivate Tool
            
            Plan->>MCP: Update task â†’ DONE
            Note over Plan: 04:46:09.536
        end
        
        Note over Plan: All 3 tasks completed<br/>Task 1: 20.18s | Task 2: 17.61s | Task 3: 13.45s<br/>Total execution: ~51.24s
        
        Plan-->>Manager: Execution summary<br/>3/3 tasks completed
        deactivate Plan
        
        Manager->>Redis: Save conversation
        Manager-->>Router: Success (59.66s)
        deactivate Manager
        Router-->>Client: HTTP 200
        deactivate Router
        Client-->>User: "Security Plan Complete"
    end

    %% Timing Summary
    Note over User,Tool: â±ï¸ Total Timing Breakdown:<br/><br/>PHASE 1 (Plan Creation): 45.39s<br/>â€¢ Manager Analysis: 6.157s<br/>â€¢ Plan Init + MCP: 1.537s<br/>â€¢ Analyze Input (LLM): 14.338s<br/>â€¢ Get Device List (MCP): 0.733s<br/>â€¢ Create 3 Plans (LLM): 22.606s<br/><br/>PHASE 2 (Plan Execution): 59.66s<br/>â€¢ Manager Analysis: 5.642s<br/>â€¢ Plan Init: 1.529s<br/><br/>ğŸ“Œ Task 1 (Turn off ÄÃ¨n tráº§n): 20.18s<br/>  â””â”€ Iteration 0 (LLM): 7.414s<br/>  â””â”€ get_device_list: 0.182s<br/>  â””â”€ Iteration 1 (LLM): 6.166s<br/>  â””â”€ switch_on_off: 0.305s<br/>  â””â”€ Iteration 2 (LLM): 5.166s<br/><br/>ğŸ“Œ Task 2 (Turn off ÄÃ¨n Ä‘á»c sÃ¡ch): 17.61s<br/>  â””â”€ Iteration 0 (LLM): 8.103s<br/>  â””â”€ get_device_list: 0.189s<br/>  â””â”€ Iteration 1 (LLM): 3.832s<br/>  â””â”€ switch_on_off: ~4s<br/>  â””â”€ Iteration 2 (LLM): ~1.5s<br/><br/>ğŸ“Œ Task 3 (Turn on ÄÃ¨n ngá»§): 13.45s<br/>  â””â”€ Iteration 0 (LLM): ~4.3s<br/>  â””â”€ get_device_list: 0.733s<br/>  â””â”€ Iteration 1 (LLM): 3.825s<br/>  â””â”€ switch_on_off: 1.358s<br/>  â””â”€ Iteration 2 (LLM): 1.224s<br/><br/>â€¢ Finalization: 1.25s<br/><br/>ğŸ”´ Bottleneck: LLM calls (Phase 1: 36.944s | Phase 2 Tasks: ~41.8s)<br/>ğŸ’¡ Architecture: Managerâ†’Planâ†’Tool (nested 3-agent cascade)<br/>ğŸ“Š Phase 1: 81.4% LLM | Phase 2: 81.6% LLM per task
