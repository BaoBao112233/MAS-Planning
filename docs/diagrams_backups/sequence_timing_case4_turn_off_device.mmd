sequenceDiagram
    autonumber
    participant Client
    participant Router as FastAPI Router<br/>(template.router.v1.ai)
    participant Manager as Manager Agent<br/>(template.agent.manager)
    participant Tool as Tool Agent<br/>(template.agent.tool)
    participant MCP as MCP Client<br/>(SSE Connection)
    participant LLM as Gemini 2.5 Pro<br/>(Reasoning Engine)
    participant OXII as OXII IoT Platform
    participant History as Session History<br/>(Redis)

    Note over Client,History: â±ï¸ Case 4: Device Control - Turn Off (Optimized)<br/>Total Duration: ~22.32s

    rect rgb(200, 230, 255)
    Note right of Client: ğŸ• 04:42:33.592<br/>Request Start
    Client->>+Router: POST /ai/chat/text<br/>{"sessionId": "testing1234",<br/>"message": "Turn off Light 1 in the bed room"}
    Note right of Router: ğŸ”‘ Token received: eyJhbGciOi...
    end

    rect rgb(220, 240, 255)
    Note right of Router: ğŸ• 04:42:33.611 (+19ms)<br/>Manager Init
    Router->>+Manager: initialize()<br/>input="Turn off Light 1...", token=JWT
    Note right of Manager: âœ… Manager initialized<br/>ğŸ“¥ Processing input
    end

    rect rgb(240, 250, 255)
    Note right of Manager: ğŸ• 04:42:33.620 (+28ms)<br/>Analysis Start
    Manager->>Manager: ğŸ” Analyzing query
    Note right of Manager: ğŸ“š Using 6 messages context<br/>(includes previous Turn On command)
    
    Note right of Manager: ğŸ• 04:42:36.471 (+2.85s)<br/>â±ï¸ LLM Routing: ~2.85s (faster!)
    Manager->>Manager: ğŸ§  LLM Routing Decision
    Note right of Manager: ğŸ¯ Decision: "tool"<br/>Confidence: 1.00<br/>Reasoning: Direct device control
    end

    rect rgb(255, 240, 200)
    Note right of Manager: ğŸ• 04:42:36.472 (+2.88s)<br/>Tool Agent Init
    Manager->>+Tool: route_to_tool()
    Note right of Tool: âš ï¸ nest_asyncio warning
    
    Tool->>+MCP: connect_sse()
    Note right of MCP: ğŸ• 04:42:36.473<br/>Connecting to OXII API
    MCP->>OXII: GET /sse
    OXII-->>MCP: session_id: 0694dd40e3304fb99a5d592a47b6a723
    Note right of MCP: ğŸ• 04:42:36.690 (+217ms)<br/>Connection faster
    MCP-->>-Tool: MCP ready
    
    Note right of Tool: ğŸ• 04:42:37.013 (+540ms)<br/>ğŸ”§ Loaded 13 MCP tools
    Tool->>Manager: Tool Agent loaded
    Note right of Tool: ğŸ¯ NEW REQUEST received
    end

    rect rgb(230, 220, 255)
    Note right of Tool: ğŸ• 04:42:37.013 (+3.42s)<br/>ğŸ§  Optimized Processing
    Note right of Tool: âš ï¸ Log detail missing<br/>but execution completes faster
    Tool->>+LLM: process_with_context()<br/>Context: Previous "Turn On" execution<br/>Known device: ÄÃ¨n 1 (buttonId: 1662)
    Note right of LLM: ğŸš€ Optimization:<br/>- Device already known from context<br/>- Skip redundant get_device_list<br/>- Direct control execution
    end

    rect rgb(220, 255, 255)
    Note right of LLM: ğŸ• 04:42:55.930 (+18.92s)<br/>â±ï¸ Processing: ~18.92s
    LLM-->>-Tool: Execute switch_on_off_controls_v2<br/>{"data": 0.0, "buttonId": 1662}
    
    Tool->>+MCP: call_tool("switch_on_off_controls_v2")
    Note right of MCP: Direct execution<br/>No intermediate steps
    MCP->>OXII: POST /messages/<br/>Control command (OFF)
    
    OXII-->>MCP: Success: Light 1 turned off
    MCP-->>-Tool: âœ… Completed
    
    Tool->>MCP: cleanup()
    Note right of Tool: ğŸ§¹ Session closed
    end

    rect rgb(255, 240, 255)
    Note right of Tool: ğŸ• 04:42:55.930 (+22.34s)<br/>Final Response
    Tool-->>-Manager: output="âœ… Command to turn off Light 1..."
    Note right of Manager: ğŸ“ Finalizing response
    end

    rect rgb(220, 255, 220)
    Note right of Manager: ğŸ• 04:42:55.939 (+22.35s)<br/>Response Complete
    Manager->>History: save_conversation()
    Note right of History: ğŸ’¾ Saved to session: testing1234
    
    Note right of Manager: âœ… Processed in 22.32s<br/>(7.59s faster than Turn On!)
    Manager-->>-Router: response
    Router-->>-Client: HTTP 200 OK
    end

    Note over Client,History: ğŸ“Š Performance Comparison vs Case 3:<br/>â€¢ Manager routing: 2.85s (vs 8.5s, -66% âš¡)<br/>â€¢ Tool Agent init: 540ms (vs 1.088s, -50% âš¡)<br/>â€¢ Processing: ~18.92s (optimized, skip device list)<br/>â€¢ Total: 22.32s (vs 29.91s, -25% improvement âš¡)<br/><br/>ğŸ¯ Key Optimization: Context-aware execution<br/>â€¢ Reuses device info from previous interaction<br/>â€¢ Skips redundant get_device_list call<br/>â€¢ Direct control command execution
