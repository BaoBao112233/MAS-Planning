sequenceDiagram
    autonumber
    participant Client
    participant Router as FastAPI Router<br/>(template.router.v1.ai)
    participant Manager as Manager Agent<br/>(template.agent.manager)
    participant Tool as Tool Agent<br/>(template.agent.tool)
    participant MCP1 as MCP Client #1<br/>(Tool Loading)
    participant LLM as Gemini 2.5 Pro<br/>(Reasoning Engine)
    participant MCP2 as MCP Client #2<br/>(Device List)
    participant MCP3 as MCP Client #3<br/>(Device Control)
    participant OXII as OXII IoT Platform
    participant History as Session History<br/>(Redis)

    Note over Client,History: â±ï¸ Case 3: Device Control - Turn On (Complete Workflow)<br/>Total Duration: ~29.91s

    rect rgb(200, 230, 255)
    Note right of Client: ğŸ• 04:41:33.697<br/>Request Start
    Client->>+Router: POST /ai/chat/text<br/>{"sessionId": "testing1234",<br/>"message": "Turn On Light 1 in the bed room."}
    Note right of Router: ğŸ”‘ Token received: eyJhbGciOi...
    end

    rect rgb(220, 240, 255)
    Note right of Router: ğŸ• 04:41:33.703 (+6ms)<br/>Manager Init
    Router->>+Manager: initialize()<br/>input="Turn On Light 1...", token=JWT
    Note right of Manager: âœ… Manager initialized<br/>ğŸ“¥ Processing input
    end

    rect rgb(240, 250, 255)
    Note right of Manager: ğŸ• 04:41:33.706 (+9ms)<br/>Analysis Start
    Manager->>Manager: ğŸ” Analyzing query
    Note right of Manager: ğŸ“š Using 5 messages context
    
    Note right of Manager: ğŸ• 04:41:42.204 (+8.5s)<br/>â±ï¸ LLM Routing: ~8.5s
    Manager->>Manager: ğŸ§  LLM Routing Decision
    Note right of Manager: ğŸ¯ Decision: "tool"<br/>Confidence: 1.00<br/>Reasoning: Device control command
    end

    rect rgb(255, 240, 200)
    Note right of Manager: ğŸ• 04:41:42.204 (+8.5s)<br/>Tool Agent Init
    Manager->>+Tool: route_to_tool()
    Note right of Tool: âš ï¸ nest_asyncio warning
    
    Tool->>+MCP1: connect_sse()
    Note right of MCP1: ğŸ• 04:41:42.205<br/>Connecting to OXII API
    MCP1->>OXII: GET /sse
    OXII-->>MCP1: session_id: 2206e1bb56094c5ca12e381a3b8a087e
    Note right of MCP1: ğŸ• 04:41:42.952 (+747ms)<br/>Connection established
    MCP1-->>-Tool: MCP ready
    
    Note right of Tool: ğŸ• 04:41:43.293 (+1.088s)<br/>ğŸ”§ Loaded 13 MCP tools
    Tool->>Manager: Tool Agent loaded
    Note right of Tool: ğŸ¯ NEW REQUEST received
    end

    rect rgb(230, 220, 255)
    Note right of Tool: ğŸ• 04:41:43.297 (+1.6s)<br/>ğŸ§  ITERATION 0: Reasoning
    Tool->>+LLM: analyze_request()<br/>SystemMessage + HumanMessage
    Note right of LLM: ğŸ¤” Planning:<br/>Need device list first
    
    Note right of LLM: ğŸ• 04:41:49.578 (+6.28s)<br/>â±ï¸ Reasoning: ~6.28s
    LLM-->>-Tool: tool_calls: [get_device_list]
    Note right of Tool: ğŸ’­ Tool planned: get_device_list
    end

    rect rgb(200, 255, 230)
    Note right of Tool: ğŸ• 04:41:49.579 (+15.88s)<br/>âš™ï¸ Execution: get_device_list (implied)
    Note right of Tool: Log shows jump to Iteration 1<br/>Assuming get_device_list executed
    Note right of Tool: Device data retrieved with house/room structure
    end

    rect rgb(255, 230, 220)
    Note right of Tool: ğŸ• 04:41:50.265 (+16.57s)<br/>ğŸ§  ITERATION 1: Control Planning
    Tool->>+LLM: reason_with_device_data()<br/>Previous: device list<br/>Goal: Turn On Light 1
    Note right of LLM: ğŸ¤” Analysis:<br/>ÄÃ¨n 1 (buttonId: 1662)<br/>Action: switch_on_off_controls_v2
    
    Note right of LLM: ğŸ• 04:41:58.043 (+7.78s)<br/>â±ï¸ Reasoning: ~7.78s
    LLM-->>-Tool: tool_calls: [switch_on_off_controls_v2]
    Note right of Tool: ğŸ’­ Control command planned
    end

    rect rgb(220, 255, 255)
    Note right of Tool: ğŸ• 04:41:58.043 (+24.35s)<br/>âš™ï¸ Execution: Control Device
    Note right of Tool: ğŸš€ Phase 1: Parallel execution
    
    Tool->>+MCP3: create_client()
    Note right of MCP3: ğŸ• 04:41:58.043<br/>New session for control
    MCP3->>OXII: GET /sse
    OXII-->>MCP3: session_id: 3270ee0d07ca4d3084aecd320872e614
    Note right of MCP3: ğŸ• 04:41:58.258 (+215ms)
    MCP3-->>-Tool: Client ready
    
    Tool->>+MCP3: call_tool("switch_on_off_controls_v2",<br/>{"data": 1.0, "buttonId": 1662, "token": JWT})
    Note right of MCP3: ğŸ• 04:41:58.589<br/>â³ Invoking control API
    MCP3->>OXII: POST /messages/<br/>Control command
    
    Note right of OXII: ğŸ• 04:42:00.936 (+2.35s)<br/>Device control executed
    OXII-->>MCP3: Success: ÄÃ¨n 1 turned on
    MCP3-->>-Tool: âœ… Completed
    
    Tool->>MCP3: cleanup()
    Note right of Tool: ğŸ§¹ Session closed
    end

    rect rgb(255, 240, 255)
    Note right of Tool: ğŸ• 04:42:00.940 (+27.24s)<br/>ğŸ§  ITERATION 2: Final Response
    Tool->>+LLM: format_response()<br/>Result: ÄÃ¨n 1 turned on successfully
    
    Note right of LLM: ğŸ• 04:42:03.604 (+2.66s)<br/>â±ï¸ Response formatting: ~2.66s
    LLM-->>-Tool: final_answer: "âœ… Command sent successfully"
    Note right of Tool: ğŸ’¬ Final output ready
    end

    rect rgb(220, 255, 220)
    Note right of Tool: ğŸ• 04:42:03.607 (+29.91s)<br/>Response Complete
    Tool-->>-Manager: output="âœ… Command to turn on ÄÃ¨n 1..."
    Note right of Manager: ğŸ“ Finalizing response
    Manager->>History: save_conversation()
    Note right of History: ğŸ’¾ Saved to session: testing1234
    
    Note right of Manager: ğŸ• 04:42:03.617 (+29.92s)<br/>âœ… Processed in 29.91s
    Manager-->>-Router: response
    Router-->>-Client: HTTP 200 OK
    end

    Note over Client,History: ğŸ“Š Performance Breakdown:<br/>â€¢ Manager LLM routing: 8.5s<br/>â€¢ Tool Agent init + MCP: 1.088s<br/>â€¢ Iteration 0 reasoning: 6.28s<br/>â€¢ Iteration 1 reasoning: 7.78s<br/>â€¢ Device control execution: 2.35s<br/>â€¢ Iteration 2 response: 2.66s<br/>â€¢ Total: 29.91s
