sequenceDiagram
    autonumber
    participant Client
    participant Router as FastAPI Router
    participant Manager as Manager Agent
    participant Plan as Plan Agent
    participant MCP_Plan as MCP Clients<br/>(Plan Agent)
    participant LLM as Gemini 2.5 Pro
    participant Tool as Tool Agent
    participant MCP_Tool as MCP Clients<br/>(Tool Exec)
    participant OXII as OXII IoT Platform
    participant API as Backend API<br/>(Task Tracking)
    participant History as Session History

    Note over Client,History: ⏱️ Case 5A: Plan Creation Phase<br/>Duration: ~45.39s

    rect rgb(200, 230, 255)
    Note right of Client: 🕐 04:44:06.240<br/>Plan Creation Request
    Client->>+Router: POST /ai/chat/text<br/>"Have 1 person in Bed room.<br/>Temperature: 20C. Create Plan."
    end

    rect rgb(220, 240, 255)
    Note right of Router: 🕐 04:44:06.247 (+7ms)
    Router->>+Manager: initialize()
    Note right of Manager: 📚 Using 6 messages context
    
    Note right of Manager: 🕐 04:44:12.413 (+6.16s)<br/>LLM Routing
    Manager->>Manager: 🧠 Analyze
    Note right of Manager: 🎯 Decision: "plan"<br/>Confidence: 1.00<br/>Keyword: "Create Plan"
    end

    rect rgb(255, 240, 200)
    Note right of Manager: 🕐 04:44:12.414 (+6.17s)<br/>Plan Agent Init
    Manager->>+Plan: route_to_plan()
    Plan->>MCP_Plan: connect_sse() x2
    Note right of MCP_Plan: 2 MCP sessions:<br/>• 472f4729... (tools)<br/>• f7f1c86f... (execution)
    MCP_Plan-->>Plan: 13 tools loaded (x2)
    Note right of Plan: 🕐 04:44:13.951 (+1.7s)
    end

    rect rgb(230, 255, 230)
    Note right of Plan: 🕐 04:44:13.952 (+1.71s)<br/>📋 STEP 1: Input Analysis
    Plan->>+LLM: analyze_input()<br/>Context + Requirements
    Note right of LLM: 🤔 Understanding:<br/>• 1 person in room<br/>• Temperature: 20°C<br/>• Need automation plan
    
    Note right of LLM: 🕐 04:44:28.290 (+14.34s)
    LLM-->>-Plan: Primary Intent + Requirements
    Note right of Plan: ✅ Analysis complete
    end

    rect rgb(255, 230, 255)
    Note right of Plan: 🕐 04:44:28.290 (+22.05s)<br/>📋 STEP 2: Device Discovery
    Plan->>MCP_Plan: get_device_list()
    MCP_Plan->>OXII: Fetch devices
    Note right of OXII: 🕐 04:44:29.024 (+734ms)
    OXII-->>MCP_Plan: 13757 chars device data
    MCP_Plan-->>Plan: 6 rooms with devices
    Note right of Plan: ✅ Devices retrieved
    end

    rect rgb(230, 230, 255)
    Note right of Plan: 🕐 04:44:29.024 (+22.78s)<br/>📋 STEP 3: Plan Generation
    Plan->>+LLM: generate_plans()<br/>Device data + Requirements
    Note right of LLM: 🤖 Creating 3 priority plans:<br/>• Security: simulate presence<br/>• Convenience: comfort focus<br/>• Energy: power saving
    
    Note right of LLM: 🕐 04:44:51.630 (+22.61s)<br/>LLM Generation: ~22.61s
    LLM-->>-Plan: 3 plans (9 tasks total)
    Note right of Plan: ✅ Security: 3 tasks<br/>✅ Convenience: 3 tasks<br/>✅ Energy: 3 tasks
    end

    rect rgb(220, 255, 220)
    Note right of Plan: 🕐 04:44:51.632 (+45.39s)<br/>Response
    Plan-->>-Manager: Present 3 plan options
    Manager->>History: save_conversation()
    Note right of Router: 💾 Store plan options
    Manager-->>-Router: Plans ready for selection
    Router-->>-Client: HTTP 200 OK<br/>3 plans presented
    end

    Note over Client,History: ⏱️ Case 5B: Plan Execution Phase<br/>Duration: ~59.66s (18.5s wait + 41.16s)

    rect rgb(200, 230, 255)
    Note right of Client: 🕐 04:45:10.144 (+18.5s)<br/>User Selection
    Client->>+Router: POST /ai/chat/text<br/>"Plan 1" (Security Plan)
    end

    rect rgb(220, 240, 255)
    Note right of Router: 🕐 04:45:10.151 (+7ms)
    Router->>+Manager: process("Plan 1")
    Note right of Manager: 📚 6 messages context
    
    Note right of Manager: 🕐 04:45:15.795 (+5.64s)<br/>LLM Routing
    Manager->>Manager: 🧠 Analyze selection
    Note right of Manager: 🎯 Decision: "plan"<br/>📋 Load cached options
    end

    rect rgb(255, 240, 200)
    Note right of Manager: 🕐 04:45:15.796 (+5.65s)<br/>Plan Execution Init
    Manager->>+Plan: execute_plan(1)
    Plan->>MCP_Plan: reconnect_sse() x2
    Note right of MCP_Plan: New sessions:<br/>• 1e5ca9d9...<br/>• 434b300f...
    MCP_Plan-->>Plan: Tools reloaded
    Note right of Plan: 🕐 04:45:17.278 (+7.13s)<br/>Selected: Security Plan
    end

    rect rgb(255, 230, 230)
    Note right of Plan: 🕐 04:45:17.280 (+7.14s)<br/>📊 Task Tracking Setup
    Plan->>+API: create_plan_tracking()
    API-->>-Plan: Plan ID: 0763bb89-...<br/>Task IDs: 871cebae, ea592b3c, f4cd9ba8
    Plan->>API: update_status(RUNNING)
    Note right of API: 🕐 04:45:18.118 (+7.98s)
    end

    rect rgb(230, 255, 255)
    Note right of Plan: 🕐 04:45:18.626 (+8.49s)<br/>🔧 Task 1/3: Turn off Đèn trần
    Plan->>+Tool: execute_task(1)
    Tool->>MCP_Tool: connect_sse()
    Note right of Tool: Session: 70f92b3c...
    Tool->>LLM: reason() → get_device_list
    Tool->>MCP_Tool: execute → switch_on_off_v2
    MCP_Tool->>OXII: Control device
    Note right of OXII: 🕐 04:45:34.123 (+15.5s)
    OXII-->>MCP_Tool: ✅ Đèn trần OFF
    Tool-->>-Plan: Task 1 complete
    Plan->>API: update_task(DONE)
    Note right of API: 🕐 04:45:39.294 (+20.67s)
    end

    rect rgb(255, 255, 230)
    Note right of Plan: 🕐 04:45:39.555 (+29.41s)<br/>🔧 Task 2/3: Turn off Đèn đọc sách
    Plan->>+Tool: execute_task(2)
    Tool->>LLM: reason() → device_list + control
    Tool->>MCP_Tool: execute switch_on_off_v2
    MCP_Tool->>OXII: Control device
    Note right of OXII: 🕐 04:45:56.907 (+17.35s)
    OXII-->>MCP_Tool: ✅ Đèn đọc sách OFF
    Tool-->>-Plan: Task 2 complete
    Plan->>API: update_task(DONE)
    end

    rect rgb(230, 255, 230)
    Note right of Plan: 🕐 04:45:57.194 (+47.05s)<br/>🔧 Task 3/3: Turn on Đèn ngủ
    Plan->>+Tool: execute_task(3)
    Tool->>LLM: reason() → control
    Tool->>MCP_Tool: execute switch_on_off_v2
    MCP_Tool->>OXII: Control device
    Note right of OXII: 🕐 04:46:08.016 (+10.82s)
    OXII-->>MCP_Tool: ✅ Đèn ngủ ON
    Tool-->>-Plan: Task 3 complete
    Plan->>API: update_task(DONE)
    Note right of API: 🕐 04:46:09.536 (+59.39s)
    end

    rect rgb(220, 255, 220)
    Note right of Plan: 🕐 04:46:09.537 (+59.39s)<br/>Completion
    Plan->>API: update_plan(DONE)
    Plan-->>-Manager: Execution complete
    Manager->>History: save_conversation()
    Note right of Manager: 🕐 04:46:09.819 (+59.66s)<br/>✅ Total: 59.66s
    Manager-->>-Router: Success response
    Router-->>-Client: HTTP 200 OK<br/>Security Plan executed
    end

    Note over Client,History: 📊 Performance Summary:<br/><br/>Phase A - Plan Creation (45.39s):<br/>• Input analysis: 14.34s<br/>• Device discovery: 0.73s<br/>• LLM plan generation: 22.61s<br/>• Setup & finalize: 7.71s<br/><br/>Phase B - Plan Execution (59.66s):<br/>• Setup & tracking: 7.98s<br/>• Task 1 execution: 20.67s<br/>• Task 2 execution: 17.35s<br/>• Task 3 execution: 12.34s<br/>• Finalization: 1.32s<br/><br/>Total: 105.05s (45.39s + 59.66s)
