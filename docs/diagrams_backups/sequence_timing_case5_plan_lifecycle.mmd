sequenceDiagram
    autonumber
    participant Client
    participant Router as FastAPI Router
    participant Manager as Manager Agent
    participant Plan as Plan Agent
    participant MCP_Plan as MCP Clients<br/>(Plan Agent)
    participant LLM as Gemini 2.5 Pro
    participant Tool as Tool Agent
    participant MCP_Tool as MCP Clients<br/>(Tool Exec)
    participant OXII as OXII IoT Platform
    participant API as Backend API<br/>(Task Tracking)
    participant History as Session History

    Note over Client,History: â±ï¸ Case 5A: Plan Creation Phase<br/>Duration: ~45.39s

    rect rgb(200, 230, 255)
    Note right of Client: ğŸ• 04:44:06.240<br/>Plan Creation Request
    Client->>+Router: POST /ai/chat/text<br/>"Have 1 person in Bed room.<br/>Temperature: 20C. Create Plan."
    end

    rect rgb(220, 240, 255)
    Note right of Router: ğŸ• 04:44:06.247 (+7ms)
    Router->>+Manager: initialize()
    Note right of Manager: ğŸ“š Using 6 messages context
    
    Note right of Manager: ğŸ• 04:44:12.413 (+6.16s)<br/>LLM Routing
    Manager->>Manager: ğŸ§  Analyze
    Note right of Manager: ğŸ¯ Decision: "plan"<br/>Confidence: 1.00<br/>Keyword: "Create Plan"
    end

    rect rgb(255, 240, 200)
    Note right of Manager: ğŸ• 04:44:12.414 (+6.17s)<br/>Plan Agent Init
    Manager->>+Plan: route_to_plan()
    Plan->>MCP_Plan: connect_sse() x2
    Note right of MCP_Plan: 2 MCP sessions:<br/>â€¢ 472f4729... (tools)<br/>â€¢ f7f1c86f... (execution)
    MCP_Plan-->>Plan: 13 tools loaded (x2)
    Note right of Plan: ğŸ• 04:44:13.951 (+1.7s)
    end

    rect rgb(230, 255, 230)
    Note right of Plan: ğŸ• 04:44:13.952 (+1.71s)<br/>ğŸ“‹ STEP 1: Input Analysis
    Plan->>+LLM: analyze_input()<br/>Context + Requirements
    Note right of LLM: ğŸ¤” Understanding:<br/>â€¢ 1 person in room<br/>â€¢ Temperature: 20Â°C<br/>â€¢ Need automation plan
    
    Note right of LLM: ğŸ• 04:44:28.290 (+14.34s)
    LLM-->>-Plan: Primary Intent + Requirements
    Note right of Plan: âœ… Analysis complete
    end

    rect rgb(255, 230, 255)
    Note right of Plan: ğŸ• 04:44:28.290 (+22.05s)<br/>ğŸ“‹ STEP 2: Device Discovery
    Plan->>MCP_Plan: get_device_list()
    MCP_Plan->>OXII: Fetch devices
    Note right of OXII: ğŸ• 04:44:29.024 (+734ms)
    OXII-->>MCP_Plan: 13757 chars device data
    MCP_Plan-->>Plan: 6 rooms with devices
    Note right of Plan: âœ… Devices retrieved
    end

    rect rgb(230, 230, 255)
    Note right of Plan: ğŸ• 04:44:29.024 (+22.78s)<br/>ğŸ“‹ STEP 3: Plan Generation
    Plan->>+LLM: generate_plans()<br/>Device data + Requirements
    Note right of LLM: ğŸ¤– Creating 3 priority plans:<br/>â€¢ Security: simulate presence<br/>â€¢ Convenience: comfort focus<br/>â€¢ Energy: power saving
    
    Note right of LLM: ğŸ• 04:44:51.630 (+22.61s)<br/>LLM Generation: ~22.61s
    LLM-->>-Plan: 3 plans (9 tasks total)
    Note right of Plan: âœ… Security: 3 tasks<br/>âœ… Convenience: 3 tasks<br/>âœ… Energy: 3 tasks
    end

    rect rgb(220, 255, 220)
    Note right of Plan: ğŸ• 04:44:51.632 (+45.39s)<br/>Response
    Plan-->>-Manager: Present 3 plan options
    Manager->>History: save_conversation()
    Note right of Router: ğŸ’¾ Store plan options
    Manager-->>-Router: Plans ready for selection
    Router-->>-Client: HTTP 200 OK<br/>3 plans presented
    end

    Note over Client,History: â±ï¸ Case 5B: Plan Execution Phase<br/>Duration: ~59.66s (18.5s wait + 41.16s)

    rect rgb(200, 230, 255)
    Note right of Client: ğŸ• 04:45:10.144 (+18.5s)<br/>User Selection
    Client->>+Router: POST /ai/chat/text<br/>"Plan 1" (Security Plan)
    end

    rect rgb(220, 240, 255)
    Note right of Router: ğŸ• 04:45:10.151 (+7ms)
    Router->>+Manager: process("Plan 1")
    Note right of Manager: ğŸ“š 6 messages context
    
    Note right of Manager: ğŸ• 04:45:15.795 (+5.64s)<br/>LLM Routing
    Manager->>Manager: ğŸ§  Analyze selection
    Note right of Manager: ğŸ¯ Decision: "plan"<br/>ğŸ“‹ Load cached options
    end

    rect rgb(255, 240, 200)
    Note right of Manager: ğŸ• 04:45:15.796 (+5.65s)<br/>Plan Execution Init
    Manager->>+Plan: execute_plan(1)
    Plan->>MCP_Plan: reconnect_sse() x2
    Note right of MCP_Plan: New sessions:<br/>â€¢ 1e5ca9d9...<br/>â€¢ 434b300f...
    MCP_Plan-->>Plan: Tools reloaded
    Note right of Plan: ğŸ• 04:45:17.278 (+7.13s)<br/>Selected: Security Plan
    end

    rect rgb(255, 230, 230)
    Note right of Plan: ğŸ• 04:45:17.280 (+7.14s)<br/>ğŸ“Š Task Tracking Setup
    Plan->>+API: create_plan_tracking()
    API-->>-Plan: Plan ID: 0763bb89-...<br/>Task IDs: 871cebae, ea592b3c, f4cd9ba8
    Plan->>API: update_status(RUNNING)
    Note right of API: ğŸ• 04:45:18.118 (+7.98s)
    end

    rect rgb(230, 255, 255)
    Note right of Plan: ğŸ• 04:45:18.626 (+8.49s)<br/>ğŸ”§ Task 1/3: Turn off ÄÃ¨n tráº§n
    Plan->>+Tool: execute_task(1)
    Tool->>MCP_Tool: connect_sse()
    Note right of Tool: Session: 70f92b3c...
    Tool->>LLM: reason() â†’ get_device_list
    Tool->>MCP_Tool: execute â†’ switch_on_off_v2
    MCP_Tool->>OXII: Control device
    Note right of OXII: ğŸ• 04:45:34.123 (+15.5s)
    OXII-->>MCP_Tool: âœ… ÄÃ¨n tráº§n OFF
    Tool-->>-Plan: Task 1 complete
    Plan->>API: update_task(DONE)
    Note right of API: ğŸ• 04:45:39.294 (+20.67s)
    end

    rect rgb(255, 255, 230)
    Note right of Plan: ğŸ• 04:45:39.555 (+29.41s)<br/>ğŸ”§ Task 2/3: Turn off ÄÃ¨n Ä‘á»c sÃ¡ch
    Plan->>+Tool: execute_task(2)
    Tool->>LLM: reason() â†’ device_list + control
    Tool->>MCP_Tool: execute switch_on_off_v2
    MCP_Tool->>OXII: Control device
    Note right of OXII: ğŸ• 04:45:56.907 (+17.35s)
    OXII-->>MCP_Tool: âœ… ÄÃ¨n Ä‘á»c sÃ¡ch OFF
    Tool-->>-Plan: Task 2 complete
    Plan->>API: update_task(DONE)
    end

    rect rgb(230, 255, 230)
    Note right of Plan: ğŸ• 04:45:57.194 (+47.05s)<br/>ğŸ”§ Task 3/3: Turn on ÄÃ¨n ngá»§
    Plan->>+Tool: execute_task(3)
    Tool->>LLM: reason() â†’ control
    Tool->>MCP_Tool: execute switch_on_off_v2
    MCP_Tool->>OXII: Control device
    Note right of OXII: ğŸ• 04:46:08.016 (+10.82s)
    OXII-->>MCP_Tool: âœ… ÄÃ¨n ngá»§ ON
    Tool-->>-Plan: Task 3 complete
    Plan->>API: update_task(DONE)
    Note right of API: ğŸ• 04:46:09.536 (+59.39s)
    end

    rect rgb(220, 255, 220)
    Note right of Plan: ğŸ• 04:46:09.537 (+59.39s)<br/>Completion
    Plan->>API: update_plan(DONE)
    Plan-->>-Manager: Execution complete
    Manager->>History: save_conversation()
    Note right of Manager: ğŸ• 04:46:09.819 (+59.66s)<br/>âœ… Total: 59.66s
    Manager-->>-Router: Success response
    Router-->>-Client: HTTP 200 OK<br/>Security Plan executed
    end

    Note over Client,History: ğŸ“Š Performance Summary:<br/><br/>Phase A - Plan Creation (45.39s):<br/>â€¢ Input analysis: 14.34s<br/>â€¢ Device discovery: 0.73s<br/>â€¢ LLM plan generation: 22.61s<br/>â€¢ Setup & finalize: 7.71s<br/><br/>Phase B - Plan Execution (59.66s):<br/>â€¢ Setup & tracking: 7.98s<br/>â€¢ Task 1 execution: 20.67s<br/>â€¢ Task 2 execution: 17.35s<br/>â€¢ Task 3 execution: 12.34s<br/>â€¢ Finalization: 1.32s<br/><br/>Total: 105.05s (45.39s + 59.66s)
